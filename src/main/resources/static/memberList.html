<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>会员列表</title>
    <script src="plugins/jquery/jquery-3.2.0.min.js"></script>
    <!-- layui -->
    <!--        <link rel="stylesheet" href="plugins/layui/css/layui.css" media="all"/>-->
    <!--        <script src="plugins/layui/layui.js"></script>-->
    <!--    <link rel="stylesheet" href="plugins/layui-v2.4.0/css/layui.css" media="all" />-->
    <!--    <script src="plugins/layui-v2.4.0/layui.js"></script>-->
    <link rel="stylesheet" href="plugins/layui-v2.7.5/css/layui.css" media="all"/>
    <script src="plugins/layui-v2.7.5/layui.js"></script>

    <!-- 图标库 -->
    <link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css" media="all"/>
    <!-- ztree -->
    <link rel="stylesheet" href="plugins/ztree/css/metroStyle/metroStyle.css"/>
    <script src="plugins/ztree/js/jquery.ztree.all.js"></script>
    <!-- 下拉列表 -->
    <script src="js/common/combobox.js"></script>
    <script src="js/common/inputTree.js"></script>
    <!-- 全局属性 -->
    <script src="js/common/setting.js"></script>
    <script src="js/common/app.js"></script>
    <!-- css -->
    <link rel="stylesheet" href="css/app.css"/>
    <!-- 加载formSelects -->
    <link rel="stylesheet" href="plugins/formSelects/formSelects-v4.css"/>
    <script src="plugins/formSelects/formSelects-v4.js"></script>
    <link rel="stylesheet" href="css/console.css">
</head>

<body>
<div class="layui-fluid member-list-page">

    <div class="think-box-shadow">
        <fieldset>
            <legend>条件搜索</legend>
            <form class="layui-form layui-form-pane form-search" lay-filter="searchForm" action="">
                <div class="layui-form-item layui-inline">
                    <label class="layui-form-label">关键词</label>
                    <div class="layui-input-inline">
                        <input name="keyword" value="" placeholder="请输入用户名称,手机号码,IP" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item layui-inline">
                    <label class="layui-form-label">注册时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="time" class="layui-input" id="registrationTime" placeholder="请选择注册时间">
                    </div>
                </div>
                <div class="layui-form-item layui-inline">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-inline">
                        <select name="memberStatus">
                            <option value="">所有状态</option>
                            <option value="1">真人</option>
                            <option value="2">假人</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item layui-inline">
                    <button type="submit" class="layui-btn layui-btn-danger" lay-submit lay-filter="search"><i
                            class="layui-icon"></i> 搜 索
                    </button>
                    <!--                    <a href="#" class="layui-btn layui-btn-danger"><i class="layui-icon"></i> 导 出</a>-->
                </div>
            </form>

            <!--            <div class="layui-form-item">-->
            <!--                <div class="layui-input-inline">-->
            <!--                    <input id="dazhen_per" name="dazhen_per" value="" placeholder="请输入打针幅度"-->
            <!--                           class="layui-input"/>-->
            <!--                </div>-->
            <!--                <div class="layui-input-inline" style="margin-left: 8px;">-->
            <!--                    <input id="dazhen_ci" name="dazhen_per" value=""-->
            <!--                           placeholder="打针单数(不填代表每次)"-->
            <!--                           class="layui-input"/>-->
            <!--                </div>-->
            <!--                <button style="margin-left: 8px;" id="dazhen" class="layui-btn layui-btn-danger">-->
            <!--                    <i class="layui-icon"></i>-->
            <!--                    批量打针-->
            <!--                </button>-->
            <!--            </div>-->
        </fieldset>
        <!--        <script>-->
        <!--            var test = "0";-->
        <!--            $("#selectList").find("option[value=" + test + "]").prop("selected", true);-->
        <!--            form.render()-->
        <!--        </script>-->

    </div>

    <div class="layui-btn-container" style="margin-top: 20px;">
        <button class="layui-btn" id="createBtn">添加会员</button>
    </div>

    <table id="member-list" lay-filter="member-list" style="margin-top: 5px"></table>

    <!--修改邀请码表单-->
    <div id="upInviteCodeId" style="display: none">
        <form class="layui-form layui-card" action="">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">邀请码</label>
                    <div class="layui-input-block">
                        <input type="text" name="inviteCode" required id="newInviteCode" lay-verify="required"
                               placeholder="请输入邀请码" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="hr-line-dashed"></div>
                <div class="layui-form-item text-center" style="text-align: center;">
                    <button class="layui-btn" lay-submit lay-filter="upInviteCodeSubmit">提交</button>
                    <button type="reset" class="layui-btn layui-btn-danger" id="dupInviteCodeCancel">取消</button>
                </div>
            </div>
        </form>
    </div>

    <!--扣款表单-->
    <div id="deductionId" style="display: none">
        <form class="layui-form layui-card" lay-filter="deductionForm">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">金额</label>
                    <div class="layui-input-block">
                        <input type="number" name="operaMount" lay-verify="number" placeholder="请输入金额"
                               autocomplete="off"
                               class="layui-input">
                        <p class="help-block">正表示加，负表示扣</p>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-block">
                        <input type="text" name="remank" placeholder="请输入备注" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="hr-line-dashed"></div>
                <div class="layui-form-item text-center" style="text-align: center;">
                    <button class="layui-btn" lay-submit lay-filter="deductionSubmit">提交</button>
                    <button type="reset" class="layui-btn layui-btn-danger" id="deductionCancel">取消</button>
                </div>
            </div>
        </form>
    </div>

    <!--派单-->
    <div id="dispatchId" style="display: none">
        <form class="layui-form layui-card" lay-filter="dispatchForm" >
            <h3 style="padding: 10px 0 0 45px; color: red;" id="dispatchText"> 该用户今日已抢单：0单 ## 卡单起始单数 1</h3>
            <h3 style="padding: 10px 0 0 45px; color: red;"> 说明：卡单 设置完毕后 大于卡单起始单数的 卡单 将被一起推送给用户</h3>
            <div class="layui-card-body">
                <div id="dispatchListView"></div>
                <div>
                    <button type="button" id="addDispatchItem" class="layui-btn layui-btn-sm" style="margin-left: 504px">
                        <i class="layui-icon">&#xe654;</i>添加卡单
                    </button>
                </div>
                <div class="hr-line-dashed"></div>
                <div class="layui-form-item text-center" style="text-align: center;">
                    <button class="layui-btn" lay-submit lay-filter="dispatchSubmit">提交</button>
                    <button type="reset" class="layui-btn layui-btn-danger" id="dispatchCancel">取消</button>
                </div>
            </div>
        </form>
    </div>

    <script id="dispatchDemo" type="text/html">
        {{#  layui.each(d.list, function(index, item){ }}
        <div class="layui-form-item">
            <label class="layui-form-label">{{index + 1}}: 第几单</label>
            <div class="layui-input-block J_div">
                <input name="orderQuantity[{{index}}]" placeholder="第几单" value="{{ item.orderQuantity }}" class="layui-input J_id_num"
                       style="display: inline; width: 10%;"/> min(元):
                <input name="minPrice[{{index}}]" value="{{ item.minPrice }}" lay-verify="required" placeholder="请输入min" class="layui-input J_min"
                       style="display: inline; width: 20%;"> max(元):
                <input name="maxPrice[{{index}}]" value="{{ item.maxPrice }}" lay-verify="required" placeholder="请输入max" class="layui-input J_max"
                       style="display: inline; width: 20%;">卡单:
                <input type="checkbox" name="hinder[{{index}}]" {{item.hinder === 1 ? 'checked' : ''}} value="1" class="layui-input J_sign" lay-filter="lock">
            </div>
        </div>
        {{#  }); }}
        {{#  if(d.list.length === 0){ }}
        无数据
        {{#  } }}
    </script>

    <!--编辑菜单-->
    <div id="editId" style="display: none">
        <form class="layui-form layui-card" lay-filter="editForm">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">用户名称</label>
                    <div class="layui-input-block">
                        <input name="userAccount" lay-verify="required" placeholder="请输入用户名称" value=""
                               class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">手机号码</label>
                    <div class="layui-input-block">
                        <input name="phoneNumber" lay-verify="phone" placeholder="请输入手机号码" value=""
                               class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">账号余额</label>
                    <div class="layui-input-block">
                        <input name="balance" type="number" min="0" placeholder="请输入账号余额" lay-verify="number"
                               class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">冻结金额</label>
                    <div class="layui-input-block">
                        <input name="freezeBalance" type="number" min="0" placeholder="冻结金额" value=""
                               class="layui-input" disabled>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required">设定金额</label>
                    <div class="layui-input-block">
                        <input name="limitAmount" type="number" lay-verify="limitAmount" min="100" placeholder="请输入设定金额，不能小于100" value=""
                               class="layui-input" />
                    </div>
                </div>
                <!--                <div class="layui-form-item">-->
                <!--                    <div class="layui-inline">-->
                <!--                        <label class="layui-form-label label-required">匹配区间</label>-->
                <!--                        <div class="layui-input-inline"-->
                <!--                             style="width: 100px;display:flex;flex-direction: row;align-items: center;">-->
                <!--                            <input type="text" name="match_min" placeholder="最小" value="0" autocomplete="off"-->
                <!--                                   class="layui-input"/>-->
                <!--                            <span> %</span>-->
                <!--                        </div>-->
                <!--                        <div class="layui-form-mid">-</div>-->
                <!--                        <div class="layui-input-inline"-->
                <!--                             style="width: 100px;display:flex;flex-direction: row;align-items: center;">-->
                <!--                            <input-->
                <!--                                    type="text" name="match_max" placeholder="最大" value="0" autocomplete="off"-->
                <!--                                    class="layui-input"/>-->
                <!--                            <span> %</span>-->
                <!--                        </div>-->
                <!--                    </div>-->
                <!--                </div>-->
                <div class="layui-form-item">
                    <label class="layui-form-label label-required">会员等级</label>
                    <div class="layui-input-block">
                        <select id="memberLevelSelect" name="memberLevelId" lay-verify="required">
<!--                            <option value="1" selected="">1</option>-->
<!--                            <option value="2">2</option>-->
<!--                            <option value="3">3</option>-->
<!--                            <option value="4">4</option>-->
                        </select>
                    </div>
                </div>
                <!--                <div class="layui-form-item">-->
                <!--                    <label class="layui-form-label label-required">交易状态</label>-->
                <!--                    <div class="layui-input-block">-->
                <!--                        <select name="deal_status" id="deal_status">-->
                <!--                            <option value="1" selected="">正常</option>-->
                <!--                            <option value="0">冻结</option>-->
                <!--                        </select>-->
                <!--                    </div>-->
                <!--                </div>-->
                <div class="layui-form-item">
                    <label class="layui-form-label">登录密码</label>
                    <div class="layui-input-block">
                        <input name="password" placeholder="留空不修改密码" class="layui-input">
                    </div>
                </div>
                <!--                <div class="layui-form-item">-->
                <!--                    <label class="layui-form-label">交易密码</label>-->
                <!--                    <div class="layui-input-block">-->
                <!--                        <input name="pwd2" placeholder="留空不修改交易密码" class="layui-input">-->
                <!--                    </div>-->
                <!--                </div>-->
                <div class="layui-form-item">
                    <label class="layui-form-label">上级ID</label>
                    <div class="layui-input-block">
                        <input name="parentUserId" placeholder="请输入上级ID" value="0" class="layui-input"/>
                    </div>
                </div>
                <div class="hr-line-dashed"></div>
                <div class="layui-form-item text-center" style="text-align: center;">
                    <button class="layui-btn" lay-submit lay-filter="editSubmit">提交</button>
                    <button type="reset" class="layui-btn layui-btn-danger" id="editCancel">取消</button>
                </div>
            </div>
        </form>
    </div>

    <!--地址信息-->
    <div id="addressInfoId" style="display: none">
        <form class="layui-form layui-card" lay-filter="addressInfoForm" autocomplete="off">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label">收货姓名</label>
                    <div class="layui-input-block">
                        <input name="name" placeholder="请输入收货姓名" value="" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">收货手机</label>
                    <div class="layui-input-block">
                        <input name="tel" lay-verify="phone" value="" placeholder="请输入收货手机" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">详细地址</label>
                    <div class="layui-input-block">
                        <input name="address" lay-verify="required" value="" placeholder="请输入详细地址" class="layui-input"/>
                    </div>
                </div>
            </div>
            <div class="hr-line-dashed"></div>
            <div class="layui-form-item text-center" style="text-align: center;">
                <button class="layui-btn" lay-submit lay-filter="addressInfoSubmit">提交</button>
                <button type="reset" class="layui-btn layui-btn-danger" id="addressInfoCancel">取消</button>
            </div>
        </form>
    </div>

    <!--    创建会员-->
    <div id="createId" style="display: none">
        <form class="layui-form layui-card" lay-filter="createForm">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">用户名称</label>
                    <div class="layui-input-block">
                        <input name="userAccount" placeholder="请输入用户名" lay-verify="required" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">手机号码</label>
                    <div class="layui-input-block">
                        <input name="phoneNumber" lay-verify="phone" placeholder="请输入手机号码" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">登录密码</label>
                    <div class="layui-input-block">
                        <input name="password" lay-verify="required" placeholder="请输入登录密码" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">上级ID</label>
                    <div class="layui-input-block">
                        <input name="parentUserId" placeholder="请输入上级ID" class="layui-input"/>
                    </div>
                </div>
            </div>
            <div class="hr-line-dashed"></div>
            <div class="layui-form-item text-center">
                <button class="layui-btn" type="button" lay-submit lay-filter="createSubmit">提交</button>
                <button class="layui-btn layui-btn-danger" type="button" data-close="" id="createCancel">取消</button>
            </div>
        </form>
    </div>

    <!--    发送消息-->
    <div id="sendMessageId" style="display: none">
        <form class="layui-form layui-card" lay-filter="sendMessageForm">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">标题</label>
                    <div class="layui-input-block">
                        <input name="noticeTitle" placeholder="请输入标题" lay-verify="required" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">内容</label>
                    <div class="layui-input-block">
                        <input name="noticeContent" placeholder="请输入内容" lay-verify="required" class="layui-input"/>
                    </div>
                </div>

                <div class="hr-line-dashed"></div>
                <div class="layui-form-item text-center">
                    <button class="layui-btn" type="button" lay-submit lay-filter="sendMessageSubmit">提交</button>
                    <button class="layui-btn layui-btn-danger" type="button" data-close="" id="sendMessageCancel">取消
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!--银行卡信息-->
    <div id="bankCardInfoId" style="display: none">
        <form class="layui-form layui-card" lay-filter="bankCardInfoForm">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">开户名</label>
                    <div class="layui-input-block">
                        <input name="accountName" placeholder="请输入开户名" lay-verify="required" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">银行名称</label>
                    <div class="layui-input-block">
                        <input name="bankName" placeholder="请输入银行名称" lay-verify="required" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">银行编号</label>
                    <div class="layui-input-block">
                        <input name="bankNumber" placeholder="请输入银行编号" lay-verify="required" class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">银行卡号</label>
                    <div class="layui-input-block">
                        <input name="cardNum" type="number" placeholder="请输入银行卡号" lay-verify="required"
                               class="layui-input"/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label label-required label-required-next">银行所在国家</label>
                    <div class="layui-input-block">
                        <input name="bankCountry" placeholder="请输入银行所在国家" lay-verify="required" class="layui-input"/>
                    </div>
                </div>

                <div class="hr-line-dashed"></div>
                <div class="layui-form-item text-center">
                    <button class="layui-btn" type="button" lay-submit lay-filter="bankCardInfoSubmit">提交</button>
                    <button class="layui-btn layui-btn-danger" type="button" data-close="" id="bankCardInfoCancel">取消
                    </button>
                </div>
            </div>
        </form>
    </div>

</div>

<!--账号-->
<script type="text/html" id="userAccount">
    <div>
        <div>手机号：{{=d.phoneNumber}}</div>
        <div>用户名：{{=d.userAccount}}</div>
        <div class="layui-btn layui-btn-xs layui-btn-normal">{{=d.memberStatus === 1 ? '真人' : '假人'}}</div>
    </div>
</script>

<!--会员等级-->
<script type="text/html" id="memberLevelId">
    <div>
        <div>{{$.findName(memberLevelOptions, d.memberLevelId)}}</div>
        <div style="color: red">0% - 0%</div>
    </div>
</script>

<!--账户余额-->
<!--缺少利息宝金额-->
<script type="text/html" id="balance">
    <div>
        <div>账户余额:{{$.financial(d.balance)}}</div>
        <div>冻结金额:{{$.financial(d.freezeBalance)}}</div>
        <div>利息宝金额:</div>
    </div>
</script>

<!--邀请码-->
<script type="text/html" id="inviteCode">
    <div>
        <div class="layui-btn layui-btn-sm" lay-event="upInviteCode">修改</div>
        <span>{{=d.inviteCode}}</span>
    </div>
</script>

<!--注册信息-->
<script type="text/html" id="register">
    <div>
        <p>{{ layui.util.toDateString(d.registrationTime, 'yyyy-MM-dd')}}</p>
        <p>{{ d.registerCountry}}{{ d.registerIp ? '(' + d.registerIp +')' : ''}}</p>
    </div>
</script>

<!--操作-->
<script type="text/html" id="operation">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-xs" lay-event="deduction">扣款</a>
        <a class="layui-btn layui-btn-xs" lay-event="dispatch">派单</a>
        <a class="layui-btn layui-btn-xs" lay-event="bankCardInfo">银行卡信息</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-xs" lay-event="toggleState">{{=d.status === 1 ? '启用' : '禁用'}}</a>
        <a class="layui-btn layui-btn-xs" lay-event="drawalStatus">{{=d.drawalStatus === 1 ? '正常提现' : '禁止提现'}}</a>
        <a class="layui-btn layui-btn-xs" lay-event="sendMessage">发送消息</a>
<!--    </span>-->
<!--    <span style="display: inline-block">-->
        <a class="layui-btn layui-btn-xs" lay-event="addressInfo">地址信息</a>
        <a class="layui-btn layui-btn-xs" lay-event="viewTeam" style="margin-bottom: 0">查看团队</a>
        <a class="layui-btn layui-btn-xs" lay-event="accountChange" style="margin-bottom: 0">帐变</a>
        <a class="layui-btn layui-btn-xs" lay-event="realPerson" style="margin-bottom: 0">设为{{=d.memberStatus === 1 ? '假人' : '真人'}}</a>
        <a class="layui-btn layui-btn-xs" lay-event="delete" style="margin-bottom: 0">删除</a>
    </div>
</script>

<script>


    layui.use(['table', 'form', 'laydate', 'laytpl'], function () {
        var table = layui.table, $ = layui.$, form = layui.form;
        var laydate = layui.laydate;
        var laytpl = layui.laytpl;

        // 表格当前选择项
        var tableCurrentItem = {};
        var currentAddressInfoItem = {};
        var currentBankCardInfoItem = {};

        // 扣款弹窗Index
        var deductionIndex;
        // 修改邀请码弹窗Index
        var upInviteCodeIndex;
        // 派单弹窗Index
        var dispatchIndex;
        var editIndex;
        var addressInfoIndex;
        var bankCardInfoIndex;
        var sendMessageIndex;

        var memberLevelOptions = [
            { name: '普通会员', value: 1 },
            { name: '黄金会员', value: 2 },
            { name: '铂金会员', value: 3 },
            { name: '钻石会员', value: 4 },
            { name: '至尊会员', value: 5 },
        ];
        memberLevelOptions.forEach(function (item) {
            var option = document.createElement('option');
            option.setAttribute('value', item.value);
            option.innerText = item.name;
            $('#memberLevelSelect').append(option);
        });

        laydate.render({
            elem: '#registrationTime',
            range: true //或 range: '~' 来自定义分割字符
        });

        form.verify({
            limitAmount: function(value, item) {
                if (!value) {
                    return '设定金额不能为空'
                }
                var v = Number(value);
                if (v < 100) {
                    return '设定金额不能小于100'
                }
            }
        });

        // 派单列表数据
        var dispatchList = []
        var dispatchDemo = document.getElementById('dispatchDemo');
        var getTpl = dispatchDemo.innerHTML;
        var dispatchListView = document.getElementById('dispatchListView');

        var renderDispatchList = function (list) {
            laytpl(getTpl).render({ list: list }, function(html){
                dispatchListView.innerHTML = html;
                form.render();
            });
        }

        renderDispatchList(dispatchList);

        var onGetDispatchFormData = function () {
            var fd = form.val('dispatchForm');
            // var list = [];
            console.log('f', fd);
            var list = dispatchList.map((item, index) => {
                var orderQuantity = fd['orderQuantity['+ index + ']'] || '';
                var minPrice = fd['minPrice['+ index + ']'] || '';
                var maxPrice = fd['maxPrice['+ index + ']'] || '';
                var hinder = fd['hinder['+ index + ']'] ? 1 : 2;
                return {
                    memberId: tableCurrentItem.id,
                    orderQuantity: orderQuantity,
                    minPrice: minPrice,
                    maxPrice: maxPrice,
                    hinder: hinder, // 是否卡单1.卡单2.不卡单
                };
            });
            return list;
        }
        var onAddDispatchItem = function () {
            var newDispatchList = onGetDispatchFormData();
            // var l = newDispatchList.length;
            // for (var i = l; i < (l + 5); i++) {
                newDispatchList.push({
                    memberId: tableCurrentItem.id,
                    orderQuantity: '',
                    minPrice: '',
                    maxPrice: '',
                    hinder: 2,
                })
            // }
            renderDispatchList(newDispatchList);
            dispatchList = newDispatchList;
        }
        $('#addDispatchItem').click(onAddDispatchItem)
        
        var onDispatchCheck = function (data) {
            $.request({
                url: '/action/dispatch/check',
                type: 'post',
                data: data,
                success: function () {

                }
            })
        }


        var where = {};

        var memberListTableId = 'memberListTable';
        table.render(Object.assign({}, $.tableRenderConfing, {
            elem: '#member-list',
            url: 'http://localhost:8080/action/member/list', //数据接口
            cellMinWidth: 100, //全局定义常规单元格的最小宽度
            method: 'post',
            contentType: 'application/json',
            page: true, //开启分页
            where: where,
            lineStyle: 'height: 100px; padding-bottom: 0;',
            // ID	账号	会员等级	账户余额	提现	冻结金额	上级用户	邀请码	注册信息	操作
            cols: [[ //表头
                {type: 'checkbox', fixed: 'left'}
                , {field: 'id', title: 'ID', sort: true}
                , {field: 'userAccount', title: '账号', templet: '#userAccount', width: 180}
                , {field: 'memberLevelId', title: '会员等级', templet: function (d) {
                        var name = $.findName(memberLevelOptions, d.memberLevelId);
                        // mateMin  mateMax
                        var min = d.mateMin || 0;
                        var max = d.mateMax || 0;
                        return "<div><div>" + name + "</div><div style='color: red'>" + min + "% - " + max + "%</div></div>"
                    }, sort: true, width: 110}
                , {field: 'balance', title: '账户余额', templet: '#balance', sort: true, width: 180}
                , {field: 'depositNum', title: '提现', templet: function (d) {
                        return $.financial(d.depositNum)
                    }, sort: true, minWidth: 120}
                , {field: 'freezeBalance', title: '冻结金额', templet: function (d) {
                        return $.financial(d.freezeBalance)
                    }, sort: true, minWidth: 120}
                , {field: 'parentUserName', title: '上级用户', sort: true, minWidth: 120}
                , {field: 'inviteCode', title: '邀请码', templet: '#inviteCode', sort: true, minWidth: 160}
                , {field: 'registerId', title: '注册信息', templet: '#register', sort: true, minWidth: 160}
                , {field: 'operation', title: '操作', templet: '#operation', fixed: 'right', width: 300 }
            ]],
            id: memberListTableId, // 容器唯一ID
        }));

        var actions = {
            apiUrl: {
                update: '/action/member/update/',
                delete: '/action/member/delete/',
                create: '/action/member/create',
            },
            // 刷新表格数据
            onReloadData: function () {
                table.reloadData(memberListTableId, {where: Object.assign({}, where, onGetSearchParams())});
            },
            onUpdateItem: function (id, fields, cb) {
                $.request({
                    url: actions.apiUrl.update + id,
                    type: 'post',
                    contentType: 'application/json',
                    data: fields,
                    showLoading: true,
                    success: function () {
                        actions.onReloadData();
                        layer.msg('操作成功', {icon: 1});
                        cb && cb();
                    }
                })
            },
            onDelete: function (id, cb) {
                $.request({
                    url: actions.apiUrl.delete + id,
                    type: 'get',
                    showLoading: true,
                    success: function () {
                        actions.onReloadData();
                        layer.msg('删除会员成功', {icon: 1});
                        cb && cb();
                    },
                });
            },
        };

        // 获取搜索参数
        var onGetSearchParams = function () {
            var searchData = form.val('searchForm');
            var times = $.getRangeTime(searchData.time);
            // searchData.status = Number(searchData.status) || null;
            searchData.memberStatus = Number(searchData.memberStatus) || null;
            searchData.selectBeginTime = times[0];
            searchData.selectEndTime = times[1];
            delete searchData.time;
            return searchData;
        }

        //单元格工具事件
        table.on('tool(member-list)', function (obj) { // 注：test 是 table 原始标签的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）

            // 设置当前选择项
            tableCurrentItem = Object.assign({}, data);

            // 修改邀请码
            if (layEvent === 'upInviteCode') {
                upInviteCodeIndex = layer.open({
                    type: 1,
                    // value: data.inviteCode,
                    title: '修改邀请码',
                    area: '800px',
                    content: $('#upInviteCodeId'),
                    success: function () {
                        $('#newInviteCode').val(data.inviteCode);
                        $('#upInviteCodeId').show();
                    },
                    cancel: function () {
                        $('#upInviteCodeId').hide();
                    }
                });
                // function(value, index, elem){
                //        if (!value) {
                //            layer.msg('请输入邀请码');
                //            // alert('请输入邀请码');
                //            return;
                //        }
                //        layer.close(index);
                //    }
            } else if (layEvent === 'deduction') { // 扣款
                deductionIndex = layer.open({
                    type: 1,
                    title: '扣款',
                    area: '800px',
                    content: $('#deductionId'), //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                    success: function () {
                        $('#deductionId').show();
                    },
                    cancel: function () {
                        $('#deductionId').hide();
                    }
                });
            } else if (layEvent === 'dispatch') { // 派单
                dispatchIndex = layer.open({
                    type: 1,
                    title: '派单',
                    area: ['800px', '500px'],
                    content: $('#dispatchId'),
                    success: function () {

                        $.request({
                            url: '/action/convey/qiang?memberId=' + tableCurrentItem.id,
                            success: function (result) {
                                // 该用户今日已抢单
                                var n = result.data || 0;
                                $('#dispatchText').text(' 该用户今日已抢单：'+ n +'单 ## 卡单起始单数 ' + n + 1)
                            }
                        });

                        $.request({
                            url: '/action/dispatch/list?memberId=' + tableCurrentItem.id,
                            success: function (result) {
                                var newDispatchList = result.data || [];
                                // if (newDispatchList.length < 5) {
                                //     var l = newDispatchList.length;
                                //     var orderQuantitys = newDispatchList.map(function (item) {
                                //         return item.orderQuantity;
                                //     })
                                //     var max = Math.max.apply(null, orderQuantitys)
                                //     for (var i = 0; i < 5 - l; i++) {
                                //         newDispatchList.push({
                                //             memberId: tableCurrentItem.id,
                                //             orderQuantity: max + i + 1,
                                //             minPrice: '',
                                //             maxPrice: '',
                                //             hinder: 2,
                                //         })
                                //     }
                                // }
                                renderDispatchList(newDispatchList);
                                dispatchList = newDispatchList;
                                console.log('result', result.data);
                            }
                        })
                        $('#dispatchId').show();
                    },
                    cancel: function () {
                        $('#dispatchId').hide();
                    }
                });
            } else if (layEvent === 'edit') { // 编辑菜单
                editIndex = layer.open({
                    type: 1,
                    title: '编辑菜单',
                    area: '800px',
                    content: $('#editId'),
                    success: function () {
                        form.val('editForm', data);
                        // $('#editId input[name=balance]').attr('disabled', true)
                        // $('#editId input[name=freezeBalance]').attr('disabled', true)
                        $('#editId').show();
                        // form.render();
                    },
                    cancel: function () {
                        $('#editId').hide();
                    }
                });
            } else if (layEvent === 'bankCardInfo') { // 银行卡信息
                $.request({
                    url: '/action/bank/select/' + tableCurrentItem.id,
                    type: 'get',
                    success: function (result) {
                        currentBankCardInfoItem = Object.assign({
                            accountName: '',
                            bankCountry: '',
                            bankName: '',
                            bankNumber: '',
                            cardNum: '',
                            id: '',
                        }, result.data);

                        form.val('bankCardInfoForm', currentBankCardInfoItem);
                        bankCardInfoIndex = layer.open({
                            type: 1,
                            title: '银行卡信息',
                            area: '800px',
                            content: $('#bankCardInfoId'),
                            success: function () {
                                $('#bankCardInfoId').show();
                            },
                            cancel: function () {
                                $('#bankCardInfoId').hide();
                            }
                        });
                    },
                })

                // layer.msg('没有数据', {icon: 2});
            } else if (layEvent === 'toggleState') { //状态切换
                // 帐号状态（0正常 1停用）
                actions.onUpdateItem(tableCurrentItem.id, {status: data.status === 0 ? 1 : 0})
            } else if (layEvent === 'drawalStatus') { //提现状态切换
                // 帐号状态（0正常 1停用）
                actions.onUpdateItem(tableCurrentItem.id, { drawalStatus: data.drawalStatus === 0 ? 1 : 0})
            } else if (layEvent === 'addressInfo') { // 地址信息
                $.request({
                    url: '/action/address/select/' + tableCurrentItem.id,
                    type: 'get',
                    success: function (result) {
                        currentAddressInfoItem = Object.assign({
                            address: '',
                            name: '',
                            tel: '',
                            id: '',
                        }, result.data);
                        form.val('addressInfoForm', currentAddressInfoItem);
                        addressInfoIndex = layer.open({
                            type: 1,
                            title: '地址信息',
                            area: '800px',
                            content: $('#addressInfoId'),
                            success: function () {
                                $('#addressInfoId').show();
                            },
                            cancel: function () {
                                $('#addressInfoId').hide();
                            }
                        });
                    },
                })

            } else if (layEvent === 'viewTeam') { // 查看团队
                window.parent.layui.tab.tabAdd({
                    id: new Date().getTime(),
                    title: '查看团队',
                    icon: 'fa-file',
                    url: '/viewTeam.html?id=' + data.id
                })
                // window.location.href = './viewTeam.html';
            } else if (layEvent === 'accountChange') { // 帐变
                window.parent.layui.tab.tabAdd({
                    id: 'caiwu_' + data.id,
                    title: '帐变',
                    icon: 'fa-file',
                    url: '/caiwu.html?id=' + data.id,
                })
            } else if (layEvent === 'realPerson') { // 设为真人
                // 状态:1.真人2.假人
                actions.onUpdateItem(tableCurrentItem.id, {memberStatus: data.memberStatus === 1 ? 2 : 1})
            } else if (layEvent === 'sendMessage') { // 发送消息
                sendMessageIndex = layer.open({
                    type: 1,
                    title: '发送消息',
                    area: '800px',
                    content: $('#sendMessageId'),
                    success: function () {
                        $('#sendMessageId').show();
                    },
                    cancel: function () {
                        $('#sendMessageId').hide();
                    }
                });

            } else if (layEvent === 'delete') { // 删除
                layer.confirm('确定要删除吗?', {title: '操作确认'}, function (index) {
                    actions.onDelete(data.id, function () {
                        layer.close(index);
                    });
                });
            }

        });

        // 搜索
        form.on('submit(search)', function (data) {
            console.log(data.field);
            actions.onReloadData();
            return false;
        });

        // 邀请码-提交
        form.on('submit(upInviteCodeSubmit)', function (formData) {
            actions.onUpdateItem(tableCurrentItem.id, formData.field, function () {
                layer.close(upInviteCodeIndex);
                $('#upInviteCodeId').hide();
            });
            return false;
        });
        // 邀请码-取消
        $('#dupInviteCodeCancel').click(function () {
            layer.close(upInviteCodeIndex);
        });

        // 扣款-提交
        form.on('submit(deductionSubmit)', function (data) {
            var fd = Object.assign({}, data.field, {
                memberId: tableCurrentItem.id,
            });
            fd.operaMount = Number(fd.operaMount);
            $.request({
                url: '/action/deposit/deposit',
                type: 'post',
                data: fd,
                showLoading: true,
                success: function () {
                    onDeductionCancel();
                    layer.msg('扣款成功', {icon: 1});
                    actions.onReloadData();
                },
                complete: function () {
                    layer.close(deductionLoading);
                }
            });
            return false;
        });
        // 扣款-取消
        var onDeductionCancel = function () {
            form.val('deductionForm', {
                operaMount: 0,
                remank: "",
            })
            layer.close(deductionIndex);
            $('#deductionId').hide();
        }
        $('#deductionCancel').click(onDeductionCancel);


        // 派单-提交
        form.on('submit(dispatchSubmit)', function (data) {
            var fd = onGetDispatchFormData().map(function (item) {
                item.minPrice = Number(item.minPrice);
                item.maxPrice = Number(item.maxPrice);
                item.hinder = Number(item.hinder);
                item.orderQuantity = Number(item.orderQuantity);
                return item;
            });
            console.log('fd', fd);
            $.request({
                url: '/action/dispatch/assign',
                type: 'post',
                data: fd,
                showLoading: true,
                success: function (result) {
                    console.log(result);
                    onDispatchCancel();
                    actions.onReloadData();
                    layer.msg('派单成功', {icon: 1});
                }
            })
            return false;
        });
        var onDispatchCancel = function () {
            dispatchList = [];
            renderDispatchList(dispatchList);
            layer.close(dispatchIndex);
        }
        // 派单-取消
        $('#dispatchCancel').click(onDispatchCancel);


        // 编辑-提交
        form.on('submit(editSubmit)', function (data) {
            // layer.msg(JSON.stringify(data.field));
            actions.onUpdateItem(tableCurrentItem.id, data.field, function () {
                layer.close(editIndex);
                $('#editId').hide();
            })
            return false;
        });
        // 编辑-取消
        $('#editCancel').click(function () {
            layer.close(editIndex);
        });

        // 地址信息-提交
        form.on('submit(addressInfoSubmit)', function (data) {
            $.request({
                url: '/action/address/save',
                type: 'post',
                data: Object.assign({}, currentAddressInfoItem, data.field, {memberId: tableCurrentItem.id}),
                success: function () {
                    onAddressInfoCancel();
                    actions.onReloadData();
                    layer.msg('地址信息修改成功', {icon: 1});
                }
            })
            return false;
        });
        // 地址信息-取消
        var onAddressInfoCancel = function () {
            form.val('addressInfoForm', {
                address: '',
                name: '',
                tel: '',
                id: '',
            })
            layer.close(addressInfoIndex);
        };
        $('#addressInfoCancel').click(onAddressInfoCancel);

        // 银行卡-提交
        form.on('submit(bankCardInfoSubmit)', function (data) {
            $.request({
                url: '/action/bank/save',
                type: 'post',
                data: Object.assign({}, currentBankCardInfoItem, data.field, {memberId: tableCurrentItem.id}),
                success: function () {
                    layer.close(bankCardInfoIndex);
                    actions.onReloadData();
                    layer.msg('银行卡信息修改成功', {icon: 1});
                }
            })
            return false;
        });
        // 银行卡-取消
        $('#bankCardInfoCancel').click(function () {
            form.val('bankCardInfoForm', {
                accountName: '',
                bankCountry: '',
                bankName: '',
                bankNumber: '',
                cardNum: '',
            });
            layer.close(bankCardInfoIndex);
        });

        // 创建会员-提交
        form.on('submit(createSubmit)', function (data) {
            $.request({
                url: actions.apiUrl.create,
                type: 'post',
                contentType: 'application/json',
                data: data.field,
                showLoading: true,
                success: function () {
                    actions.onReloadData();
                    layer.msg('创建会员成功', {icon: 1});
                    onCreateCancel();
                },
            });
        });
        // 创建会员-取消
        var onCreateCancel = function () {
            form.val('createForm', {
                userAccount: '',
                phoneNumber: '',
                password: '',
                parentUserId: '',
            })
            layer.close(createIndex);
        }
        $('#createCancel').click(onCreateCancel);

        var createIndex;
        $('#createBtn').click(function () {
            createIndex = layer.open({
                type: 1,
                title: '创建会员',
                area: '800px',
                content: $('#createId'),
                success: function () {
                    $('#createId').show();
                },
                cancel: function () {
                    $('#createId').hide();
                }
            });
        })


        // 发送消息-提交
        form.on('submit(sendMessageSubmit)', function (data) {
            var fd = Object.assign({
                noticeClasses: 2, // 个人通知
                noticeType: 1, // 公告类型（1通知 2公告）
            }, data.field);
            $.request({
                url: '/action/notice/create',
                type: 'post',
                data: fd,
                success: function () {
                    layer.close(sendMessageIndex);
                    onSendMessageCancel();
                    layer.msg('发送消息成功', {icon: 1});
                },
            })
        });
        var onSendMessageCancel = function () {
            layer.close(sendMessageIndex);
            $('#sendMessageId').hide();
            form.val('sendMessageForm', {
                noticeTitle: '',
                noticeContent: '',
            })
        }
        $('#sendMessageCancel').click(onSendMessageCancel)

    });
</script>

</body>

</html>
