<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>会员等级</title>
	<script src="plugins/jquery/jquery-3.2.0.min.js"></script>
	<!-- layui -->
	<!--    <link rel="stylesheet" href="plugins/layui/css/layui.css" media="all"/>-->
	<!--    <script src="plugins/layui/layui.js"></script>-->
	<!--    <link rel="stylesheet" href="plugins/layui-v2.4.0/css/layui.css" media="all" />-->
	<!--    <script src="plugins/layui-v2.4.0/layui.js"></script>-->
	<link rel="stylesheet" href="plugins/layui-v2.7.5/css/layui.css" media="all" />
	<script src="plugins/layui-v2.7.5/layui.js"></script>

	<!-- 图标库 -->
	<link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css" media="all" />
	<!-- ztree -->
	<link rel="stylesheet" href="plugins/ztree/css/metroStyle/metroStyle.css" />
	<script src="plugins/ztree/js/jquery.ztree.all.js"></script>
	<!-- 下拉列表 -->
	<script src="js/common/combobox.js"></script>
	<script src="js/common/inputTree.js"></script>
	<!-- 全局属性 -->
	<script src="js/common/setting.js"></script>
	<script src="js/common/app.js"></script>
	<script src="lang/index.js"></script>
	<!-- css -->
	<link rel="stylesheet" href="css/app.css" />
	<!-- 加载formSelects -->
	<link rel="stylesheet" href="plugins/formSelects/formSelects-v4.css" />
	<script src="plugins/formSelects/formSelects-v4.js"></script>
	<link rel="stylesheet" href="css/console.css" />
</head>

<body>
<div class="layui-fluid">

	<!--新建会员等级表单-->
	<div id="createId" style="display: none">
		<form class="layui-form layui-card" lay-filter="addForm">
			<div class="layui-card-body">
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.membersName">名称</label>
					<div class="layui-input-block">
						<input name="membersName" lay-filter="membersName" lay-verify="required" required data-placeholder="请输入名称" value="" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.icon">图标</label>
					<div>
						<button type="button" class="layui-btn" id="uploadPic" data-locale="level.uploadPic">
							<i class="layui-icon">&#xe67c;</i>上传图标
						</button>
						<img name="pic" id="upload-img" lay-filter="pic" style="display: none; width: 150px;margin-left: 12px;" src="">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.memberPrice">会员价格</label>
					<div class="layui-input-block">
						<input name="memberPrice" lay-filter="memberPrice" lay-verify="required|number" required data-placeholder="level.petMemberPrice" value="" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.commission">佣金比例</label>
					<div class="layui-input-block">
						<input name="commission" lay-filter="commission" lay-verify="required|number" type="number" min="0" step='0.001' required
							   data-placeholder="level.petCommission" value=""
							   class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.numMin">最小余额</label>
					<div class="layui-input-block">
						<input name="numMin" lay-filter="numMin" lay-verify="required|number" type="number" min="0" required data-placeholder="level.petNumMin" value="" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.orderNum">接单次数</label>
					<div class="layui-input-block">
						<input name="orderNum" lay-filter="orderNum" lay-verify="required|number" required data-placeholder="level.petOrderNum" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.withdrawalTimes">提现次数</label>
					<div class="layui-input-block">
						<input name="withdrawalTimes" lay-filter="withdrawalTimes" lay-verify="required|number" required
							   data-placeholder="level.petWithdrawalTimes" value="" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.mate">匹配区间</label>
					<div class="layui-input-inline" style="width: 100px; margin-right: 4px">
						<input type="number" name="mateMin" min="0" data-placeholder="level.petMateMin" lay-verify="required|number" class="layui-input">
					</div>
					<div class="layui-form-mid layui-word-aux">%</div>
					<div class="layui-form-mid">-</div>
					<div class="layui-input-inline" style="width: 100px; margin-right: 4px">
						<input type="number" name="mateMax" min="0" data-placeholder="level.petMateMax" lay-verify="required|number" class="layui-input">
					</div>
					<div class="layui-form-mid layui-word-aux">%</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.withdrawalMin">提现最小金额</label>
					<div class="layui-input-block">
						<input name="withdrawalMin" lay-filter="withdrawalMin" lay-verify="required|number" required
							   data-placeholder="level.petWithdrawalMin" value="" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.withdrawalMax">提现最大金额</label>
					<div class="layui-input-block">
						<input name="withdrawalMax" lay-filter="withdrawalMax" lay-verify="required|number" required
							   data-placeholder="level.petWithdrawalMax" value="" class="layui-input" />
					</div>
				</div>
				<div class="hr-line-dashed"></div>
				<div class="layui-form-item text-center">
					<button type="button" class="layui-btn" lay-submit lay-filter="createSubmit" data-locale="submit">提交</button>
					<button type="button" class="layui-btn layui-btn-danger" id="createCancel" data-locale="cancel">取消</button>
				</div>
			</div>
		</form>
	</div>

	<!--编辑表单-->
	<div id="editId" style="display: none">
		<form class="layui-form layui-card" lay-filter="editForm">
			<div class="layui-card-body">
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.membersName">名称</label>
					<div class="layui-input-block">
						<input name="membersName" required data-placeholder="level.petMembersName" lay-verify="required" value="" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.icon">图片</label>
					<div>
						<button type="button" class="layui-btn" id="updatePic" data-locale="level.uploadPic">
							<i class="layui-icon">&#xe67c;</i>上传图片
						</button>
						<img name="pic" id="update-img" style="display: none; width: 100px;margin-left: 12px;" src="">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.memberPrice">会员价格</label>
					<div class="layui-input-block">
						<input name="memberPrice" lay-verify="required|number" required data-placeholder="level.petMemberPrice" value="" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.commission">佣金比例</label>
					<div class="layui-input-block">
						<input name="commission" lay-verify="required|number" type="number" min="0" required data-placeholder="level.petCommission" value=""
							   class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.numMin">最小余额</label>
					<div class="layui-input-block">
						<input name="numMin" lay-verify="required|number" type="number" min="0" required data-placeholder="level.petNumMin" value="" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.orderNum">接单次数</label>
					<div class="layui-input-block">
						<input name="orderNum"   lay-verify="required|number" required data-placeholder="level.petOrderNum" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.withdrawalTimes">提现次数</label>
					<div class="layui-input-block">
						<input name="withdrawalTimes" lay-verify="required|number" required data-placeholder="level.petWithdrawalTimes" value="" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.mate">匹配区间</label>
					<div class="layui-input-inline" style="width: 100px; margin-right: 4px">
						<input type="number" name="mateMin" min="0" data-placeholder="level.petMateMin" lay-verify="required|number" class="layui-input">
					</div>
					<div class="layui-form-mid layui-word-aux">%</div>
					<div class="layui-form-mid">-</div>
					<div class="layui-input-inline" style="width: 100px; margin-right: 4px">
						<input type="number" name="mateMax" min="0" data-placeholder="level.petMateMax" lay-verify="required|number" class="layui-input">
					</div>
					<div class="layui-form-mid layui-word-aux">%</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.withdrawalMin">提现最小金额</label>
					<div class="layui-input-block">
						<input name="withdrawalMin" lay-verify="required|number" required data-placeholder="level.petWithdrawalMin" value="" class="layui-input" />
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label label-required label-required-next" data-locale="level.withdrawalMax">提现最大金额</label>
					<div class="layui-input-block">
						<input name="withdrawalMax" lay-verify="required|number" required data-placeholder="level.petWithdrawalMax" value="" class="layui-input" />
					</div>
				</div>
				<div class="hr-line-dashed"></div>
				<div class="layui-form-item text-center">
					<button class="layui-btn" lay-submit lay-filter="editSubmit" data-locale="submit">提交</button>
					<button type="button" class="layui-btn layui-btn-danger" id="editCancel" data-locale="cancel">取消</button>
				</div>
			</div>
		</form>
	</div>


	<div class="layui-btn-container" style="margin-top: 20px;">
		<button class="layui-btn" id="createBtn" data-locale="level.add">添加会员等级</button>
	</div>

	<table id="level" lay-filter="level" style="margin-top: 5px"></table>
</div>

<script type="text/html" id="operation">
	<a class="layui-btn layui-btn-xs" style="background-color: green;" lay-event="edit">{{$t('edit')}}</a>
	<a class="layui-btn layui-btn-xs" style="background-color: red;" lay-event="delete">{{$t('delete')}}</a>
</script>

<!--注册信息-->
<script type="text/html" id="register">
	<div>
		<p>{{ layui.util.toDateString(d.registerTime, 'yyyy-MM-dd HH:mm:ss')}}</p>
		<p>{{ d.registerCountry}}</p>
	</div>
</script>

<script type="text/html" id="pic">
	<div>
		<img src='{{d.pic}}' alt="">
	</div>
</script>

	<script>
		layui.use(['table', 'form', 'util', 'element', 'laydate'], function () {
			var table = layui.table,
					$ = layui.$,
					form = layui.form,
					util = layui.util,
					upload = layui.upload

			var editIndex;

			var i18n = new I18n();
			var $t = i18n.$t;
			window.i18n = i18n;
			window.$t = $t;

			// 表格当前选择项
			var tableCurrentItem = {}

			var where = {
				status: 0
			}

			//执行实例
			var uploadIndex
			var uploadInst = upload.render({
				elem: '#uploadPic', //绑定元素
				url: '/action/file/upload', //上传接口
				acceptMime: 'image/*',
				before: function (obj) {
					//obj参数包含的信息，跟 choose回调完全一致，可参见上文。
					uploadIndex = layer.load(1) //上传loading
				},
				done: function (res) {
					layer.close(uploadIndex)
					var data = res.data || []
					var path = data[0].path
					var fileFullPath = $.getFileFullPath(path)
					$('#upload-img').attr('src', fileFullPath).show()
					layer.msg($t('level.uploadSucceeded'), { icon: 1 })
					//上传完毕回调
				},
				error: function (err) {
					console.log('err msg', err.msg)
					$('#upload-img').attr('src', '').hide()
					layer.close(uploadIndex)
					layer.msg(err.msg, { icon: 2 })
					//请求异常回调
				}
			})

			var updateIndex
			var uploadInst_ = upload.render({
				elem: '#updatePic', //绑定元素
				url: '/action/file/upload', //上传接口
				acceptMime: 'image/*',
				before: function (obj) {
					//obj参数包含的信息，跟 choose回调完全一致，可参见上文。
					updateIndex = layer.load(1) //上传loading
				},
				done: function (res) {
					layer.close(updateIndex)
					var data = res.data || []
					var path = data[0].path
					var fileFullPath = $.getFileFullPath(path)
					$('#update-img').attr('src', fileFullPath).show()
					layer.msg($t('level.uploadSucceeded'), { icon: 1 })
					//上传完毕回调
				},
				error: function (err) {
					console.log('err msg', err.msg)
					$('#update-img').attr('src', '').hide()
					layer.close(updateIndex)
					layer.msg(err.msg, { icon: 2 })
					//请求异常回调
				}
			})

			var parseData = function (res) {
				var msg
				var code
				var count
				var data
				if (res.code === 200) {
					code = 0
					msg = res.message
					count = res.data.total
					data = res.data.list
				} else {
					code = res.code
					msg = res.msg
					count = 0
					data = []
				}
				return {
					code: code, //解析接口状态
					msg: msg, //解析提示文本
					count: count, //解析数据长度
					data: data //解析数据列表
				}
			}

			var actions = {
				apiUrl: {
					update: '/action/level/update/',
					delete: '/action/level/delete/',
					create: '/action/level/create'
				},
				// 刷新表格数据
				onReloadData: function () {
					table.reloadData(levelListTableId, { where: Object.assign({}, where) })
				},
				onUpdateItem: function (id, fields, options) {
					var _options = Object.assign({}, requestDefOptions, options)
					$.ajax({
						url: actions.apiUrl.update + id,
						type: 'post',
						contentType: 'application/json',
						data: JSON.stringify(fields),
						success: function (result, status, xhr) {
							if (result.code === 200) {
								actions.onReloadData()
								layer.msg($t('operationSucceeded'), { icon: 1 })
								_options.success && _options.success(result, status, xhr)
							} else {
								layer.msg(result.msg, { icon: 2 })
								_options.fail && _options.fail(result, status, xhr)
							}
							_options.complete && _options.complete(status, xhr)
						},
						error: function (xhr, status, error) {
							layer.msg($t('operationFailed'), { icon: 2 })
							_options.error && _options.error(xhr, status, error)
						}
					})
				},
				onDelete: function (id, options) {
					var _options = Object.assign({}, requestDefOptions, options)
					$.ajax({
						url: actions.apiUrl.delete + id,
						type: 'get',
						success: function (result, status, xhr) {
							if (result.code === 200) {
								actions.onReloadData()
								layer.msg($t('deleteSucceeded'), { icon: 1 })
								_options.success && _options.success(result, status, xhr)
							} else {
								layer.msg(result.msg, { icon: 2 })
								_options.fail && _options.fail(result, status, xhr)
							}
							_options.complete && _options.complete(status, xhr)
						},
						error: function (xhr, status, error) {
							layer.msg($t('deleteFailed'), { icon: 2 })
							_options.error && _options.error(xhr, status, error)
						}
					})
				},
				onCreate: function (fields, options) {
					var _options = Object.assign({}, requestDefOptions, options)
					$.ajax({
						url: actions.apiUrl.create,
						type: 'post',
						contentType: 'application/json',
						data: JSON.stringify(fields),
						success: function (result, status, xhr) {
							if (result.code === 200) {
								actions.onReloadData()
								layer.msg($t('createSucceeded'), { icon: 1 })
								_options.success && _options.success(result, status, xhr)
							} else {
								layer.msg(result.msg, { icon: 2 })
								_options.fail && _options.fail(result, status, xhr)
							}
							_options.complete && _options.complete(status, xhr)
						},
						error: function (xhr, status, error) {
							layer.msg($t('createFailed'), { icon: 2 })
							_options.error && _options.error(xhr, status, error)
						}
					})
				}
			}

			//单元格工具事件
			table.on('tool(level)', function (obj) {
				// 注：test 是 table 原始标签的属性 lay-filter="对应的值"
				var data = obj.data //获得当前行数据
				var layEvent = obj.event //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
				var tr = obj.tr //获得当前行 tr 的 DOM 对象（如果有的话）

				// 设置当前选择项
				tableCurrentItem = Object.assign({}, data)
				// 修改邀请码
				if (layEvent === 'edit') {
					// 编辑菜单
					editIndex = layer.open({
						type: 1,
						title: $t('edit'),
						area: '800px',
						content: $('#editId'),
						success: function () {
							form.val('editForm', data)
							$('#update-img').attr('src', data.pic).show();
							$('#editId').show()
						},
						cancel: function () {
							$('#editId').hide()
						}
					})
				} else if (layEvent === 'delete') {
					// 删除
					layer.confirm($t('deleteConfirmation'), { title: $t('operationConfirmation') }, function (index) {
						actions.onDelete(data.id, {
							success: function () {
								layer.close(index)
							}
						})
					})
				}
			})

			var levelListTableId = 'levelListTableId'
			//第一个实例
			table.render({
				elem: '#level',
				height: 312,
				url: 'http://localhost:8080/action/level/list', //数据接口
				// url: '/action/level/list', //数据接口
				page: true, //开启分页
				cellMinWidth: 100, //全局定义常规单元格的最小宽度
				where: where,
				loading: true,
				request: {
					pageName: 'pageNum', //页码的参数名称，默认：page
					limitName: 'pageSize' //每页数据量的参数名，默认：limit
				},
				cols: [
					[
						//表头
						{ field: 'id', title: 'ID', width: 80, sort: true, fixed: 'left' },
						{ field: 'membersName', title: $t('level.membersName'), width: 120 },
						{ field: 'pic', title: $t('level.icon'), templet: '#pic', width: 100 },
						{ field: 'memberPrice', title: $t('level.memberPrice'), width: 80 },
						{ field: 'commission', title: $t('level.commission'), width: 80 },
						{ field: 'numMin', title: $t('level.numMin'), width: 80 },
						{ field: 'orderNum', title: $t('level.orderNum'), width: 80 },
						{ field: 'withdrawalTimes', title: $t('level.withdrawalTimes'), width: 100 },
						{ field: 'withdrawalMin', title: $t('level.withdrawalMin'), width: 120 },
						{ field: 'withdrawalMax', title: $t('level.withdrawalMax'), width: 120 },
						{ field: 'registerTime', title: $t('level.registerTime'), templet: '#register', minWidth: 160 },
						{ field: 'operation', title: $t('operation'), templet: '#operation', fixed: 'right', width: 336 }
					]
				],
				parseData: parseData,
				id: levelListTableId // 容器唯一IDs
			})

			// 请求回调选项
			var requestDefOptions = {
				// 请求成功，并且code等于200
				success: function (result, status, xhr) {},
				// 请求成功，并且code不等于200
				fail: function (result, status, xhr) {},
				// 请求失败
				error: function (xhr, status, error) {},
				// 请求完成时运行的函数（在请求成功或失败之后均调用，即在 success 和 error 函数之后）。
				complete: function (xhr, status) {}
			}

			// 编辑-提交
			form.on('submit(editSubmit)', function (data) {
				data.field.pic = $('#update-img').attr('src')
				delete data.field.file
				actions.onUpdateItem(tableCurrentItem.id, data.field, {
					success: function () {
						console.log('success')
						layer.close(editIndex)
						$('#editId').hide()
					}
				})
				return false
			})

			// 编辑-取消
			$('#editCancel').click(function () {
				layer.close(editIndex)
			})

			var createIndex
			$('#createBtn').click(function () {
				createIndex = layer.open({
					type: 1,
					title: $t('level.addTitle'),
					area: '800px',
					content: $('#createId'),
					success: function () {
						$('#createId').show()
					},
					cancel: function () {
						$('#createId').hide()
					}
				})
			})

			//清空form表单
			var clearForm = function () {
				form.val('addForm', {
					membersName: '',
					pic: '',
					memberPrice: '',
					commission: '',
					numMin: '',
					orderNum: '',
					withdrawalTimes: '',
					mateMin: '',
					mateMax: '',
					withdrawalMin: '',
					withdrawalMax: ''
				})
			}
			// 新建-取消
			$('#createCancel').click(function () {
				layer.close(createIndex)
				clearForm()
			})

			// 新建-提交
			form.on('submit(createSubmit)', function (data) {
				data.field.pic = $('#upload-img').attr('src')
				delete data.field.file
				actions.onCreate(data.field, {
					success: function () {
						layer.close(createIndex)
						clearForm()
					}
				})
				// return false;
			})
		})
	</script>
</body>

</html>